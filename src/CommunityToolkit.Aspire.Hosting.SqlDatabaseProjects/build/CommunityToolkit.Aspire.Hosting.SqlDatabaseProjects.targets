<Project>

    <ItemGroup>
      <_AspirePackageResource Condition="'$(ManagePackageVersionsCentrally)'!='true'" Include="@(PackageReference->WithMetadataValue('IsAspirePackageResource', 'true'))" />
      <_AspirePackageResource Condition="'$(ManagePackageVersionsCentrally)'=='true'" Include="@(PackageVersion)" />
      <_AspirePackageResource Condition="'$(ManagePackageVersionsCentrally)'=='true'" Update="@(PackageReference)">
        <IsAspirePackageResource Condition="'%(PackageReference.IsAspirePackageResource)' != ''">%(PackageReference.IsAspirePackageResource)</IsAspirePackageResource>
      </_AspirePackageResource>
    </ItemGroup>

    <!-- Generate the data structures for doing the codegen for package resources -->
    <Target Name="CreateAspirePackageMetadataSources"
            DependsOnTargets="_CreateAspireProjectResources">
      <ItemGroup>
        <AspirePackageMetadataSource Include="@(_AspirePackageResource->WithMetadataValue('IsAspirePackageResource', 'true'))" Condition="'@(_AspirePackageResource)' != ''">
          <ClassName Condition="%(_AspirePackageResource.AspirePackageMetadataTypeName) == ''">$([System.Text.RegularExpressions.Regex]::Replace(%(_AspirePackageResource.Identity), $(_GeneratedClassNameFixupRegex), '_'))</ClassName>
          <ClassName Condition="%(_AspirePackageResource.AspirePackageMetadataTypeName) != ''">$([System.Text.RegularExpressions.Regex]::Replace(%(_AspirePackageResource.AspirePackageMetadataTypeName), $(_GeneratedClassNameFixupRegex), '_'))</ClassName>
          <PackageName>@(_AspirePackageResource->'%(Identity)'->Replace('.', '_'))</PackageName>
          <PackagePath>$([System.String]::new('$(NuGetPackageRoot)%(_AspirePackageResource.Identity)/%(_AspirePackageResource.Version)').ToLower())</PackagePath>
        </AspirePackageMetadataSource>
      </ItemGroup>
    </Target>

    <Target Name="_CSharpWritePackageMetadataSources" DependsOnTargets="CreateAspirePackageMetadataSources" Condition="'$(Language)' == 'C#'">
      <ItemGroup>
        <AspirePackageMetadataSource Update="@(AspirePackageMetadataSource)">
          <Source>
          <![CDATA[// <auto-generated/>

namespace Packages%3B

[global::System.CodeDom.Compiler.GeneratedCode("Aspire.Hosting", null)]
[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage(Justification = "Generated code.")]
[global::System.Diagnostics.DebuggerDisplay("Type = {GetType().Name,nq}, PackageId = {PackageId}, PackageVersion = {PackageVersion}, PackagePath = {PackagePath}")]
]]>$(AspireGeneratedClassesVisibility)<![CDATA[ class ]]>%(ClassName)<![CDATA[ : global::Aspire.Hosting.IPackageMetadata
{
    public string PackageId => """]]>%(Identity)<![CDATA["""%3B
    public Version PackageVersion => new Version("""]]>%(Version)<![CDATA[""")%3B
    public string PackagePath => """]]>%(PackagePath)<![CDATA["""%3B
}]]>
          </Source>
        </AspirePackageMetadataSource>
      </ItemGroup>

      <WriteLinesToFile File="$(_AspireIntermediatePath)references\%(AspirePackageMetadataSource.ClassName).PackageMetadata.g.cs"
                        Overwrite="true"
                        Lines="%(AspirePackageMetadataSource.Source)"
                        Condition="%(AspirePackageMetadataSource.ClassName) != ''"
                        WriteOnlyWhenDifferent="true" />
      <ItemGroup>
        <FileWrites Include="$(_AspireIntermediatePath)references\%(AspirePackageMetadataSource.ClassName).PackageMetadata.g.cs" />
        <Compile Include="$(_AspireIntermediatePath)references\%(AspirePackageMetadataSource.ClassName).PackageMetadata.g.cs"
                Condition="%(AspirePackageMetadataSource.ClassName) != ''" />
      </ItemGroup>
    </Target>

    <PropertyGroup>
      <!-- Easy extension point for adding new languages' write support. -->
      <WriteAspirePackageMetadataSourcesDependsOn>_CSharpWritePackageMetadataSources;</WriteAspirePackageMetadataSourcesDependsOn>
    </PropertyGroup>

    <!-- The purpose of this target is to take all of the generated package metadata and write them to the intermediate build directory
      and reference them for compilation. There will be a ClassName.PackageMetadata.g.cs file for each referenced project. -->
    <Target Name="WriteAspirePackageMetadataSources" DependsOnTargets="$(WriteAspirePackageMetadataSourcesDependsOn)" BeforeTargets="CoreCompile" />
</Project>